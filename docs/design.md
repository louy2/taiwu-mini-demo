# 游戏设计文档

## 目录

1. [界面设计](#界面设计)
2. [角色属性](#角色属性)
3. [功法系统](#功法系统)
4. [装备系统](#装备系统)
5. [产业系统](#产业系统)
6. [战斗系统](#战斗系统)
7. [存档系统](#存档系统)
8. [ECS架构](#ecs架构)
9. [NPC系统](#npc系统)
10. [术语对照表](#术语对照表)

---

## 界面设计

### 极简夜读 MUD 风格

为了提供沉浸式的文本体验，界面采用"夜读模式"设计。

### 布局结构

| 区域 | 说明 |
|-----|------|
| **顶部状态栏** | 固定2行，显示角色核心属性或战斗状态 |
| **中央日志区** | 占据主要空间，显示滚动事件日志 |
| **底部抽屉** | 默认折叠，展开显示详细面板和操作按钮 |

### 视觉规范

- **背景色**: `#1a1a1a` (深色)
- **字体**: 无衬线字体 (Microsoft YaHei, PingFang SC)
- **设计原则**: 高对比度文字，去除不必要的边框和装饰

### 战斗界面

全屏战斗界面分为三个阶段:
- **prep (准备)**: 显示敌人信息，确认开始
- **active (战斗)**: 实时战斗日志，可跳过
- **result (结算)**: 显示战斗结果和奖励

---

## 角色属性

### 基础属性

6组12项属性，初始值随机 50-60:

| 攻击属性 | 防御属性 | 作用 |
|---------|---------|------|
| 力道 | 卸力 | 命中/化解判定 |
| 精妙 | 拆招 | 命中/化解判定 |
| 迅疾 | 闪避 | 命中/化解判定 |
| 动心 | 守心 | 命中/化解判定 |
| 破体 | 御体 | 外伤计算 |
| 破气 | 御气 | 内伤计算 |

> **注**: 当前版本命中判定仅使用力道/卸力，其他属性为扩展预留。

### 真气系统

- **初始值**: 80
- **最大值**: 280
- **增长**: 通过"运转周天"提升上限

### 真气分配

真气可分配为4种类型，影响属性加成:

| 类型 | 特点 |
|-----|------|
| **摧破** | 强化攻击属性，偏精妙 |
| **轻灵** | 攻防兼备，强化力道和破气 |
| **护体** | 强化防御属性，偏闪避 |
| **奇窍** | 攻防兼备，强化迅疾和破体 |

**便捷操作**:
- **全部分配**: 将剩余真气全部分配给某类型
- **平均分配**: 将剩余真气平均分配给4种类型
- **重置**: 一键重置所有已分配真气

### 内力类型

由装备的内功决定，影响真气分配时的属性加成倍率:

| 类型 | 力道/卸力 | 精妙/拆招 | 迅疾/闪避 | 动心/守心 | 破体/御体 | 破气/御气 |
|-----|:---:|:---:|:---:|:---:|:---:|:---:|
| **金刚** | 5 | 2 | 2 | 3 | 8 | 2 |
| **紫霞** | 2 | 3 | 5 | 2 | 3 | 7 |
| **玄阴** | 2 | 2 | 3 | 5 | 2 | 8 |
| **纯阳** | 3 | 3 | 3 | 3 | 5 | 5 |
| **归元** | 3 | 5 | 2 | 2 | 7 | 3 |
| **混元** | 3 | 3 | 3 | 3 | 5 | 5 |

### 真气分配效果表

| 类型 | 力道 | 精妙 | 迅疾 | 动心 | 破体 | 破气 | 卸力 | 拆招 | 闪避 | 守心 | 御体 | 御气 |
|-----|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| **摧破** | 1 | 6 | 3 | 3 | 1 | 1 | - | - | - | - | - | - |
| **轻灵** | 6 | 3 | 1 | 3 | 3 | 6 | 3 | 6 | 1 | 3 | 3 | 6 |
| **护体** | - | - | - | - | - | - | 1 | 3 | 6 | 3 | 1 | 1 |
| **奇窍** | 3 | 1 | 6 | 3 | 6 | 3 | 6 | 1 | 3 | 3 | 6 | 3 |

### 属性计算公式

```
最终属性 = 基础属性 + 内力倍率 × Σ(真气分配 × 真气类型加成) + 装备加成
```

---

## 功法系统

### 内功

- 决定角色的**内力类型**
- 决定**催破功法**和**护体功法**的装备槽位数量
- 必须装备并"运转周天"后生效

**多内功系统**:
- 可同时装备最多 **3个** 内功
- 槽位数量叠加计算
- 一个内功指定为"激活"状态，决定当前内力类型
- 不可装备重复功法

### 催破功法

- 战斗中自动施展的攻击招式
- 消耗**势**
- 效果：提升当次攻击的属性倍率

### 护体功法

- 受到攻击时自动施展的防御招式
- 消耗**提气**
- 效果：百分比减少受到的伤害

### 获取方式

- 消耗**威望**进行"访名师"随机领悟
- 重复获得同一功法时，该功法等级 +1

---

## 装备系统

### 装备槽位

| 槽位 | 加成属性 |
|-----|---------|
| **武器** | 力道、破体、破气 |
| **护甲** | 卸力、御体、御气 |

### 品阶

| 等级 | 名称 |
|:---:|-----|
| 1 | 凡品 |
| 2 | 良品 |
| 3 | 上品 |
| 4 | 极品 |
| 5 | 绝世 |

### 获取方式

- 消耗**金钱**在市集"淘装备"获得随机装备
- 新获得的装备放入背包
- 重复获得同一装备时计数 +1

---

## 产业系统

### 资源

| 资源 | 来源 | 用途 |
|-----|------|------|
| **金钱** | 市集产出 | 淘装备、扩建市集 |
| **威望** | 祠堂产出 | 访名师、修缮祠堂 |

### 建筑

| 建筑 | 产出 | 升级消耗 |
|-----|------|---------|
| **市集** | 等级 × 100 金钱/月 | 等级 × 500 金钱 |
| **祠堂** | 等级 × 10 威望/月 | 等级 × 50 威望 |

### 月份流转

每次进行"运转周天"操作时:
1. 时间流逝一个月
2. 自动产出对应资源
3. 真气上限增长

### 新手礼包

新存档获得 **1000 金钱** + **1000 威望**

---

## 战斗系统

### 战斗资源

| 资源 | 上限 | 获取方式 | 用途 |
|-----|-----|---------|------|
| **势** | 无上限 | 普通攻击命中 +1 | 施展催破功法 |
| **提气** | 30000 | 每秒恢复 1200 | 施展护体功法 |

### 命中判定

根据进攻方**力道**与防守方**卸力**对比:

```
当 力道 > 卸力: 命中率 = 力道 / 卸力
当 力道 ≤ 卸力: 命中率 = (力道 / 卸力) / 2
```

> 命中率可超过 100%

### 伤害计算

攻击命中后计算伤害，分为**外伤**和**内伤**两部分:

- **基础伤害**: 9
- **内伤比例**: 0% - 100% (由攻击方设定)
- **外伤比例**: 100% - 内伤比例

**外伤**:
```
系数 x = 破体 / 御体
衰减 y = 12.51 / (12.51 + x)
外伤 = 9 × 外伤比例 × x × y
```

**内伤**:
```
系数 x = 破气 / 御气
衰减 y = 12.51 / (12.51 + x)
内伤 = 9 × 内伤比例 × x × y
```

**总伤害** = 外伤 + 内伤

### 受伤标记

- 累计伤害 ≥ **200** 时，获得 1 个受伤标记
- 累计 **12** 个受伤标记 = 失败

### 战斗日志

- 实时滚动显示最近 3 条记录
- 详细战报保留最近 10 场
- 战斗结束日志可点击查看完整战报

---

## 存档系统

- 支持 **3个** 存档槽位
- 支持删除存档
- 旧版本存档自动迁移
- 使用 LocalStorage 持久化

---

## ECS架构

游戏采用 **Entity-Component-System (ECS)** 架构，实现数据与逻辑分离。

### 设计原则

| 概念 | 说明 |
|-----|------|
| **Entity (实体)** | 只是一个ID和组件容器，没有逻辑 |
| **Component (组件)** | 纯数据容器，定义实体的某个方面 |
| **System (系统)** | 处理拥有特定组件组合的所有实体的逻辑 |

### 组件列表

| 组件 | 用途 | 适用实体 |
|-----|------|---------|
| **Identity** | 身份信息（名字、称号、门派） | 玩家、NPC |
| **Attributes** | 12组基础属性 | 玩家、NPC |
| **Qi** | 真气系统（总量、4种分配） | 玩家、NPC |
| **Kungfu** | 功法系统（库存、装备、激活内功） | 玩家、NPC |
| **Gear** | 装备系统（武器、护甲、背包） | 玩家、NPC |
| **CombatResources** | 战斗资源（势、提气） | 玩家、NPC |
| **CombatState** | 战斗状态（伤害池、标记） | 玩家、NPC |
| **Estate** | 产业系统（金钱、威望、建筑） | 玩家 |
| **Time** | 时间系统（年、月） | 玩家 |
| **AI** | AI行为控制 | NPC |

### 系统列表

| 系统 | 职责 |
|-----|------|
| **AttributeSystem** | 计算有效属性（基础 + 真气加成 + 装备加成） |
| **CombatSystem** | 战斗逻辑、伤害计算、技能施放 |
| **QiSystem** | 真气分配管理 |
| **KungfuSystem** | 功法装备、槽位管理 |
| **GearSystem** | 装备穿戴管理 |
| **EstateSystem** | 产业升级、资源产出 |
| **NPCSystem** | NPC生成、AI行为、日常活动 |

### 架构优势

1. **统一的实体模型**: 玩家和NPC使用相同的组件，可以参与相同的系统
2. **易于扩展**: 添加新功能只需新增组件和系统
3. **数据与逻辑分离**: 便于存档、调试和测试
4. **向后兼容**: 通过 GameBridge 保持与现有代码的兼容

### 文件结构

```
wuxia-game/src/ecs/
├── index.js              # ECS入口
├── World.js              # 世界管理器
├── GameBridge.js         # 与旧代码的桥接层
├── components/
│   └── index.js          # 所有组件定义
├── entities/
│   ├── Entity.js         # 实体基类
│   ├── EntityFactory.js  # 实体工厂
│   └── index.js
└── systems/
    ├── AttributeSystem.js
    ├── CombatSystem.js
    ├── QiSystem.js
    ├── KungfuSystem.js
    ├── GearSystem.js
    ├── EstateSystem.js
    ├── NPCSystem.js
    └── index.js
```

---

## NPC系统

NPC（非玩家角色）与玩家共享相同的组件结构，可以参与所有游戏系统。

### NPC身份信息

| 属性 | 说明 |
|-----|------|
| **名字** | 随机生成（姓 + 名） |
| **称号** | 根据等级决定（如"江湖散人"、"武林新秀"） |
| **门派** | 随机分配（武当、少林、峨眉等） |

### NPC等级

NPC等级由真气决定，影响基础属性和装备品质:

| 等级 | 真气范围 | 属性加成 | 称号示例 |
|:---:|---------|---------|---------|
| 1 | 60-100 | +0 | 初入江湖 |
| 2 | 100-140 | +5 | 小有名气 |
| 3 | 140-180 | +10 | 声名鹊起 |
| 4 | 180-220 | +15 | 威震一方 |
| 5 | 220+ | +20 | 天下闻名 |

### AI行为类型

| 类型 | 真气分配偏好 | 说明 |
|-----|------------|------|
| **aggressive** | 摧破60%、轻灵20% | 攻击偏好 |
| **defensive** | 护体60%、轻灵20% | 防御偏好 |
| **balanced** | 各25% | 均衡分配 |

### NPC生成

**随机对手生成**:
- 根据玩家真气匹配等级
- 随机分配AI行为类型
- 自动配置功法和装备

**预设NPC**:
| 预设ID | 名字 | 等级 | 门派 |
|--------|------|:---:|------|
| village_guard | 村口守卫 | 1 | - |
| wandering_swordsman | 游侠剑客 | 2 | - |
| wudang_disciple | 武当弟子 | 2 | 武当派 |
| shaolin_monk | 少林僧人 | 3 | 少林寺 |
| mountain_bandit_chief | 山贼头目 | 4 | - |
| mysterious_master | 神秘高手 | 5 | - |

### NPC战斗

NPC在战斗中:
- 拥有与玩家相同的属性计算方式
- 可以使用催破和护体功法
- 根据装备获得属性加成
- 根据AI类型决定真气分配

### 日常活动

NPC每月可能进行的活动:
- **修炼**: 30%概率，真气 +1
- **调息**: 10%概率，重新分配真气

---

## 术语对照表

### 游戏术语

| 中文术语 | 英文标识 | 说明 |
|---------|---------|------|
| 真气 | qi | 角色能量，可分配提升属性 |
| 势 | shi | 战斗资源，普攻命中获得 |
| 提气 | tiqi | 战斗资源，每秒自动恢复 |
| 金钱 | money | 产业资源，市集产出 |
| 威望 | prestige | 产业资源，祠堂产出 |
| 内功 | internal | 功法类型，决定内力类型 |
| 催破 | destruction | 功法类型，攻击技能 |
| 护体 | protection | 功法类型，防御技能 |
| 力道 | power | 攻击属性，影响命中 |
| 卸力 | parry | 防御属性，影响化解 |
| 破体 | penetration | 攻击属性，影响外伤 |
| 御体 | resistance | 防御属性，减少外伤 |
| 破气 | qiBreach | 攻击属性，影响内伤 |
| 御气 | qiGuard | 防御属性，减少内伤 |

### ECS架构术语

| 术语 | 说明 |
|-----|------|
| Entity | 实体，组件的容器 |
| Component | 组件，纯数据结构 |
| System | 系统，处理逻辑 |
| World | 世界，管理所有实体和系统 |
| GameBridge | 桥接层，连接ECS与旧代码 |

### NPC相关术语

| 术语 | 说明 |
|-----|------|
| NPC | Non-Player Character，非玩家角色 |
| entityType | 实体类型（player/npc） |
| faction | 门派 |
| title | 称号 |
| behavior | AI行为类型 |
| aggression | 攻击倾向（0-1） |
